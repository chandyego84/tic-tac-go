<!DOCTYPE html>
<html lang="en">
<head>
    <title>Noob Chat + Tic-Tac-Toe</title>
    <meta charset="UTF-8" />
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            font-family: sans-serif;
        }

        #container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        #game {
            width: 40%;
            background: #f0f0f0;
            padding: 1em;
            box-sizing: border-box;
            border-right: 2px solid #ccc;
        }

        #game h2 {
            margin-top: 0;
        }

        .system-message {
            color: green;
            font-style: italic;
            margin: 5px 0;
        }

        #chat {
            width: 60%;
            display: flex;
            flex-direction: column;
            position: relative;
            background: gray;
        }

        #log {
            flex: 1;
            overflow: auto;
            background: white;
            padding: 0.5em;
            margin: 0.5em;
        }

        #form {
            padding: 0.5em;
            background: #ddd;
            display: flex;
            gap: 0.5em;
        }

        #msg_form {
            flex: 1;
        }

        #board {
            display: grid;
            grid-template-columns: repeat(3, 100px);
            grid-template-rows: repeat(3, 100px);
            gap: 5px;
            margin-top: 1em;
        }

        .cell {
            width: 100px;
            height: 100px;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            cursor: pointer;
            border: 1px solid #000;
        }

        #status {
            margin-top: 1em;
            font-weight: bold;
        }

        .popup {
            display: none;
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            border: 1px solid #ccc;
            z-index: 1000;
            padding: 20px;
        }

        .popup .close {
            cursor: pointer;
            float: right;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="game">
            <h2>Tic-Tac-Toe</h2>
            <div id="board"></div>
            <div id="status">Waiting for players...</div>
        </div>
        <div id="chat">
            <div id="log"></div>
            <form id="form">
                <input type="submit" value="Send" />
                <input type="text" id="msg_form" size="64" autofocus />
            </form>
        </div>
    </div>

    <div id="usernamePopup" class="popup">
        <span class="close" onclick="closePopup()">&times;</span>
        <form id="usernameForm">
            <label for="usernameInput">Enter a username:</label><br />
            <input type="text" id="usernameInput" required /><br /><br />
            <input type="submit" value="Join Chat" />
        </form>
    </div>

    <script>
        let conn; // websocket connection
        let msg_form = null;
        let log = null;
        let username = null;

        // game info
        let gameStarted = false;
        let gameOver = false;
        let isPlayerTurn = false;
        let playerSymbol = "";
        let boardState = Array(9).fill("");

        function appendLog(item) {
            const doScroll = log.scrollTop > log.scrollHeight - log.clientHeight - 1;
            log.appendChild(item);
            if (doScroll) {
                log.scrollTop = log.scrollHeight - log.clientHeight;
            }
        }

        // Username popup form //
        function showPopup() {
            const popup = document.getElementById("usernamePopup");
            popup.style.display = "block";
            document.getElementById("usernameInput").focus();
        }

        function closePopup() {
            document.getElementById("usernamePopup").style.display = "none";
            msg_form.focus();
        }
        
        // System messages from server
        function showSystemMessage(text) {
            const sysMsg = document.createElement("div");
            sysMsg.className = "system-message"; // style in CSS
            sysMsg.textContent = text;
            log.appendChild(sysMsg);
            log.scrollTop = log.scrollHeight;
        }

        // Tic-Tac-Toe functions //
        function createBoard() {
            const board = document.getElementById("board");
            board.innerHTML = "";
            boardState = Array(9).fill("");
            for (let i = 0; i < 9; i++) {
                const cell = document.createElement("div");
                cell.className = "cell";
                cell.dataset.index = i;
                cell.onclick = () => handleCellClick(i);
                board.appendChild(cell);
            }
        }

        function handleCellClick(index) {
            if (!isPlayerTurn || boardState[index] !== "") return;

            conn.send(JSON.stringify({
                Type: "game",
                MoveIndex: index,
                Username: username
            }));
        }

        function updateCell(index, symbol) {
            const board = document.getElementById("board");
            board.children[index].innerText = symbol;
        }

        function updateStatus(message) {
            document.getElementById("status").innerText = message;
        }

        // Window function
        window.onload = function () {
            msg_form = document.getElementById("msg_form");
            log = document.getElementById("log");

            // input username form
            document.getElementById("usernameForm").onsubmit = function (e) {
                e.preventDefault();
                const input = document.getElementById("usernameInput");
                if (input.value.trim() === "") return;

                username = input.value.trim();
                conn.send(JSON.stringify({
                    Type: "connection",
                    Username: username
                }));

                closePopup();
            };

            // message form
            document.getElementById("form").onsubmit = function () {
                if (!conn || !msg_form.value || !username) return false;
                conn.send(JSON.stringify({
                    Type: "chat",
                    ChatMessage: msg_form.value,
                    Username: username
                }));
                msg_form.value = "";

                return false;
            };

            if (window["WebSocket"]) {
                conn = new WebSocket("ws://" + document.location.host + "/ws");
                conn.onopen = function () {
                    showPopup();
                    createBoard();
                };
                conn.onclose = function () {
                    const item = document.createElement("div");
                    item.innerHTML = "<b>Connection closed.</b>";
                    appendLog(item);
                };

                // message data from the server
                conn.onmessage = function (evt) {
                    console.log("onmessage event: ", evt);
                    try {
                        const data = JSON.parse(evt.data);
                        const msgUsername = data.Username; 

                        if (data.Type == "connection") {
                            if (msgUsername === username) {
                                playerSymbol = data.Role;
                                playerSymbol != "" ? showSystemMessage(`You are assigned a player with symbol ${playerSymbol}`) : showSystemMessage("You are a spectator")
                            }
                        }
                        else if (data.Type == "chat") {
                            const chatMessages = data.ChatMessage.split('\n');
                            for (let i = 0; i < chatMessages.length; i++) {
                                const item = document.createElement("div");
                                item.innerText = msgUsername + ": " + chatMessages[i];
                                log.appendChild(item)
                            }
                        }
                        else if (data.Type == "game") {
                            // get game state info from hub
                            console.log("received game info from hub")
                            console.log(data.GameState)
                            

                            // Update local board state from server state
                            boardState = data.GameState.Board;
                            for (let i = 0; i < boardState.length; i++) {
                                updateCell(i, boardState[i]);
                            }
                        }
                    } 
                    catch (e) {
                        // fallback: treat as chat -- message from server wasnt in JSON form
                        console.log("FALLBACK: TREAT AS CHAT")
                        const messages = evt.data.split('\n');
                        for (let i = 0; i < messages.length; i++) {
                            const item = document.createElement("div");
                            item.innerText = messages[i];
                            appendLog(item);
                        }
                    }
                };
            } 
            else {
                const item = document.createElement("div");
                item.innerHTML = "<b>Your browser does not support WebSockets.</b>";
                appendLog(item);
            }
        };
    </script>
</body>
</html>
